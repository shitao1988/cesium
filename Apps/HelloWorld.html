<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Use correct character set. -->
        <meta charset="utf-8" />
        <!-- Tell IE to use the latest, best version. -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
        />
        <title>Hello World!</title>
        <script src="../Build/Cesium/Cesium.js"></script>
        <script src="plugin/TerrainClipPlan.js"></script>
        <script src="line.js"></script>
        <script src="point.js"></script>
        <style>
            @import url(../Build/Cesium/Widgets/widgets.css);
            html,
            body,
            #cesiumContainer {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <div
            style="position: absolute;
        z-index: 1;
        background-color: #fff;
        padding: 4px;
        border-radius: 2px;
        margin: 10px;"
        >
            <input
                type="checkbox"
                id="undergroundchk"
                name="地下模式"
                value="地下模式"
                οnclick="checkboxOnclick(this)"
            />
            <label id="label" for="t">地下管线</label>
        </div>

        <div id="cesiumContainer"></div>
        <script>
            function underground(t, i) {
                this._viewer = t;
                var n = Cesium.defaultValue(i, {});
                (this._depth = Cesium.defaultValue(n.depth, 500)),
                    (this._alpha = Cesium.defaultValue(n.alpha, 0.5)),
                    (this.enable = Cesium.defaultValue(n.enable, !1));
            }
            underground.prototype._updateImageryLayersAlpha = function(e) {
                for (
                    var t = this._viewer.imageryLayers._layers,
                        i = 0,
                        a = t.length;
                    i < a;
                    i++
                )
                    t[i].alpha = e;
            };
            underground.prototype._historyOpts = function() {
                var e = {};
                (e.alpha = Cesium.clone(
                    this._viewer.imageryLayers._layers[0] &&
                        this._viewer.imageryLayers._layers[0].alpha
                )),
                    (e.highDynamicRange = Cesium.clone(
                        this._viewer.scene.highDynamicRange
                    )),
                    (e.skyShow = Cesium.clone(
                        this._viewer.scene.skyAtmosphere.show
                    )),
                    (e.skyBoxShow = Cesium.clone(
                        this._viewer.scene.skyBox.show
                    )),
                    (e.depthTest = Cesium.clone(
                        this._viewer.scene.globe.depthTestAgainstTerrain
                    )),
                    this._viewer.scene.globe._surface &&
                        this._viewer.scene.globe._surface._tileProvider &&
                        this._viewer.scene.globe._surface._tileProvider
                            ._renderState &&
                        (e.blending = Cesium.clone(
                            this._viewer.scene.globe._surface._tileProvider
                                ._renderState.blending
                        )),
                    (this._oldViewOpts = e);
            };
            underground.prototype.activate = function() {
                if (!this._enable) {
                    (this._enable = !0),
                        this._historyOpts(),
                        this._updateImageryLayersAlpha(this._alpha);
                    var e = this._viewer;
                    (Cesium.ExpandBySwsk.underEarth.cullFace = !1),
                        (Cesium.ExpandBySwsk.underEarth.enable = !0),
                        (Cesium.ExpandBySwsk.underEarth.enableDepth = this._depth),
                        (Cesium.ExpandBySwsk.underEarth.enableSkirt = !0),
                        (e.scene.globe.depthTestAgainstTerrain = !0),
                        (e.scene.highDynamicRange = !1),
                        (e.scene.skyAtmosphere.show = !1),
                        (e.scene.skyBox.show = !1),
                        e.scene.globe._surface._tileProvider &&
                            e.scene.globe._surface._tileProvider._renderState &&
                            e.scene.globe._surface._tileProvider._renderState
                                .blending; /*&& (e.scene.globe._surface._tileProvider._renderState.blending.enabled = !0,
        e.scene.globe._surface._tileProvider._renderState.blending.equationRgb = Cesium.BlendEquation.ADD,
        e.scene.globe._surface._tileProvider._renderState.blending.equationAlpha = Cesium.BlendEquation.ADD,
        e.scene.globe._surface._tileProvider._renderState.blending.functionSourceAlpha = Cesium.BlendFunction.ONE,
        e.scene.globe._surface._tileProvider._renderState.blending.functionSourceRgb = Cesium.BlendFunction.ONE,
        e.scene.globe._surface._tileProvider._renderState.blending.functionDestinationAlpha = Cesium.BlendFunction.ZERO,
        e.scene.globe._surface._tileProvider._renderState.blending.functionDestinationRgb = Cesium.BlendFunction.ZERO)*/
                }
            };
            underground.prototype.disable = function() {
                if (this._enable) {
                    (this._enable = !1),
                        this._updateImageryLayersAlpha(this._oldViewOpts.alpha);
                    var e = this._viewer;
                    (Cesium.ExpandBySwsk.underEarth.cullFace = void 0),
                        (Cesium.ExpandBySwsk.underEarth.enable = !1),
                        (Cesium.ExpandBySwsk.underEarth.enableDepth = 0),
                        (Cesium.ExpandBySwsk.underEarth.enableSkirt = !1),
                        (e.scene.globe.depthTestAgainstTerrain = this._oldViewOpts.depthTest),
                        (e.scene.skyBox.show = this._oldViewOpts.skyBoxShow),
                        (e.scene.highDynamicRange = this._oldViewOpts.highDynamicRange),
                        (e.scene.skyAtmosphere.show = this._oldViewOpts.skyShow); /*,
        void 0 != this._oldViewOpts.blending && (e.scene.globe._surface._tileProvider._renderState.blending = this._oldViewOpts.blending)*/
                }
            };
            underground.prototype.destroy = function() {
                delete this._viewer,
                    delete this._alpha,
                    delete this._depth,
                    delete this._enable,
                    delete this._oldViewOpts;
            };

            var viewer = new Cesium.Viewer("cesiumContainer");

            function computeCircle(radius) {
                var positions = [];
                for (var i = 0; i < 360; i++) {
                    var radians = Cesium.Math.toRadians(i);
                    positions.push(
                        new Cesium.Cartesian2(
                            radius * Math.cos(radians),
                            radius * Math.sin(radians)
                        )
                    );
                }
                return positions;
            }

            gdline.features.forEach(fea => {
                viewer.entities.add({
                    polylineVolume: {
                        positions: Cesium.Cartesian3.fromDegreesArrayHeights([
                            fea.geometry.coordinates[0][0][0],
                            fea.geometry.coordinates[0][0][1],
                            -fea.properties["起点高"],
                            fea.geometry.coordinates[0][1][0],
                            fea.geometry.coordinates[0][1][1],
                            -fea.properties["终点高"]
                        ]),
                        outline: false,
                        shape: computeCircle(0.5),
                        material: Cesium.Color.RED
                    }
                });
            });


            gdpoint.features.forEach(fea => {
                viewer.entities.add({
                position : Cesium.Cartesian3.fromDegrees(fea.geometry.coordinates[0], fea.geometry.coordinates[1],-fea.properties["HIGH"]+1),
                // box : {
                //     dimensions : new Cesium.Cartesian3(1, 1, 1),
                //     outline : false,
                //     material : Cesium.Color.WHITE
                // }
                cylinder : {
                    length : 2.0,
                    topRadius : 1.0,//圆柱体的顶部半径。
                    bottomRadius : 1.0,//    圆柱体底部的半径。
                    material : Cesium.Color.WHITE
                }
            });
            });


            viewer.scene.globe.baseColor = new Cesium.Color(0, 0, 0, 0);
            viewer.scene.globe.depthTestAgainstTerrain = true;
            var ug = new underground(viewer, {
                depth: 5000,
                alpha: 0.6
            });
           //  ug.activate();
            viewer.zoomTo(viewer.entities);

        //     var WGS84_to_Cartesian3 = function(points) {
        //         return points.map(point => {
        //             var car33 = Cesium.Cartesian3.fromDegrees(
        //                 point.x,
        //                 point.y,
        //                 point.z
        //             );
        //             var x = car33.x;
        //             var y = car33.y;
        //             var z = car33.z;
        //             return { x: x, y: y, z: z };
        //         });
        //     };

        //   let terrainClipPlan = new Cesium.TerrainClipPlan(viewer, {
        //             height: 30,
        //              splitNum: 50,
        //              wallImg: "../Source/Images/excavate_side_min.jpg",
        //              bottomImg: "../Source/Images/excavate_bottom_min.jpg",
        //              positions:WGS84_to_Cartesian3([{ x: 119.83898685700001, y: 32.940516437000042, z: 10 },
        //          { x: 119.84108701800005, y:32.94068, z: 10 },
        //          { x: 119.84148717, y: 32.9384185, z: 10  },
        //          { x: 119.840304803, y: 32.9382428, z: 10  }])
        //          })

            let tileset3dmodel = viewer.scene.primitives.add(
                new Cesium.Cesium3DTileset({
                    url: "http://localhost:8887/cesium/3dmodel/tileset.json"
                })
            );
            viewer.scene.primitives.add(tileset3dmodel);
            tileset3dmodel.readyPromise
                .then(function(tileset) {
                    viewer.scene.primitives.add(tileset);
                    //平移、贴地、旋转模型
                    var cartographic = Cesium.Cartographic.fromCartesian(
                        tileset.boundingSphere.center
                    );
                    var surface = Cesium.Cartesian3.fromRadians(
                        cartographic.longitude,
                        cartographic.latitude,
                        cartographic.height
                    );
                    var offset = Cesium.Cartesian3.fromRadians(
                        cartographic.longitude,
                        cartographic.latitude,
                        8
                    );
                    var translation = Cesium.Cartesian3.subtract(
                        offset,
                        surface,
                        new Cesium.Cartesian3()
                    );
                    tileset.modelMatrix = Cesium.Matrix4.fromTranslation(
                        translation
                    );
                })


            let tileset = viewer.scene.primitives.add(
                new Cesium.Cesium3DTileset({
                    url: "http://localhost:8887/cesium/tileset.json"
                })
            );




            var myStyle = new Cesium.Cesium3DTileStyle({
                color: "color('#FFFFFF', 0.1)", //white, alpha = 0.2
                show: true
            });



            viewer.scene.primitives.add(tileset);

            tileset.readyPromise
                .then(function(tileset) {
                    viewer.scene.primitives.add(tileset);
                    // viewer.zoomTo(tileset, new Cesium.HeadingPitchRange(0.5, -0.2, tileset.boundingSphere.radius * 1.0));
                    //平移、贴地、旋转模型
                    var cartographic = Cesium.Cartographic.fromCartesian(
                        tileset.boundingSphere.center
                    );
                    var surface = Cesium.Cartesian3.fromRadians(
                        cartographic.longitude,
                        cartographic.latitude,
                        cartographic.height
                    );
                    var offset = Cesium.Cartesian3.fromRadians(
                        cartographic.longitude,
                        cartographic.latitude,
                        44.9
                    );
                    var translation = Cesium.Cartesian3.subtract(
                        offset,
                        surface,
                        new Cesium.Cartesian3()
                    );
                    tileset.modelMatrix = Cesium.Matrix4.fromTranslation(
                        translation
                    );
                    //update3dtilesMaxtrix(tileset);
                })
                .otherwise(function(error) {
                    console.log(error);
                });

                viewer.clock.onTick.addEventListener(function () {        
                    if(viewer.camera.pitch > 0){
                        viewer.scene.screenSpaceCameraController.enableTilt = false;
                    }
                }); 
                
                var mousePosition,startMousePosition;
                var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
                handler.setInputAction(function(movement) { 
                    mousePosition=startMousePosition= Cesium.Cartesian3.clone(movement.position);
                    handler.setInputAction(function(movement) {
                        mousePosition = movement.endPosition;
                        var y = mousePosition.y - startMousePosition.y;
                        if(y>0){
                            viewer.scene.screenSpaceCameraController.enableTilt = true;
                        }
                    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
                }, Cesium.ScreenSpaceEventType.MIDDLE_DOWN);


            var inputELe = document.getElementById("undergroundchk"); //input元素
            inputELe.addEventListener("change", function(e) {
                //给label添加事件
                if (e.target.checked) {
                    //如果当前是选中状态
                    ug.activate();
                    tileset.style = myStyle;
                    //  e.target.checked = false //置为false
                } else {
                    ug.disable();
                    tileset.style = null;
                    //  e.target.checked = true //否则置为true
                }
            });
        </script>
    </body>
</html>
